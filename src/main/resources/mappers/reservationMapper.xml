<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 게시판 네임스페이스(사용영역) 설정 -->
<mapper namespace="com.gsitm.meeting.mappers.reservationMapper">
	<select id="resList" resultType="com.gsitm.meeting.reservation.dto.ReservationDTO$ReservationTest" parameterType="string">
		select r.res_id resId,e.EMP_NAME empName, to_char(res_start_time,'YYYY-MM-DD"T"HH24:MI:SS') resStartDate,to_char(res_end_time,'YYYY-MM-DD"T"HH24:MI:SS') resEndDate ,m.mr_name mrName,r.emp_id empId
		from employee e ,reservation r,meeting_room m
		where e.emp_id = r.emp_id
		and m.mr_id = r.mr_id
		and r.res_state='res_2'
		and m.br_id = #{brId}
	</select>
	<insert id="writeReservation">
		insert into reservation (RES_ID,EMP_ID, MR_ID, RES_START_TIME, RES_END_TIME,RES_TIME,RES_PURPOSE,RES_ATTEND_CNT,RES_ADD_REQUEST,RES_STATE,RES_SNACK,RES_TYPE,RES_CANCLE,RES_COST,RES_OUTSIDE)
		values (#{resId}, #{empId}, #{meId}, #{resStartDate}, #{resEndDate},#{resDate},#{resPurpose},#{resAttendCnt},#{resAddRequest},#{resState},#{resSnack},#{resType},#{resCancle},#{resCost},#{resOutside})
	</insert>
	<select id="meetingRoomList" resultType="com.gsitm.meeting.room.dto.MeetingRoomDTO$MeetingRoomTest" parameterType="string">
		select b.br_name brName,mr_name mrName, r.br_id brId,r.mr_id mrId, mr_limit mrLimit,b.BR_LOCATION brLocation, mr_area mrArea, mr_network mrNetwork, 
		mr_type mrType, e.emp_name empName, mr_location mrLocation, mr_img mrImg, LISTAGG(eq.eq_id,',') WITHIN GROUP(ORDER BY r.mr_id) AS eqId 
		from branch b, meeting_room r, employee e,equipment eq
		where  b.BR_ID=r.br_id 
		and r.emp_id = e.emp_id
		and r.mr_id = eq.mr_id
		and b.br_id=#{brId}
		group by b.br_name,mr_name,r.br_id,r.mr_id,mr_limit,b.BR_LOCATION,mr_area,mr_network,mr_type,e.emp_name,mr_location,mr_img
	</select>
	<select id="mrReservationList" resultType="com.gsitm.meeting.reservation.dto.ReservationDTO$ReservationTest" parameterType="string">
		select m.mr_id mrId,r.res_id resId,e.EMP_NAME empName, to_char(res_start_time,'YYYY-MM-DD"T"HH24:MI:SS') resStartDate,to_char(res_end_time,'YYYY-MM-DD"T"HH24:MI:SS') resEndDate ,m.mr_name mrName,r.emp_id empId
		from employee e ,reservation r,meeting_room m
		where e.emp_id = r.emp_id
		and m.mr_id = r.mr_id
		and r.res_state='res_2'
		and r.mr_id=#{mrId}
	</select>
	<select id="meetingPeopleList" resultType="EmployeeVO">
		SELECT EMP_ID empId, EMP_NAME empName FROM EMPLOYEE
	</select>
	<select id="branchList" resultType="BranchVO">
		select br_name brName,br_id brId from branch
	</select>
	<select id="mrTypeList" resultType="MeetingRoomVO">
		select distinct(mr_type) mrType from meeting_room 
	</select>
	<select id="mrLimitList" resultType="MeetingRoomVO">
		select distinct(mr_limit) mrLimit from meeting_room 
	</select>
	<select id="equipList" resultType="EquipmentReservationVO" parameterType="string">
		select distinct(substr(eq_id,1,1)) eqId, mr_id mrId 
		from equipment
		where mr_id=#{mrId}
	</select> 
	<select id="search" resultType="com.gsitm.meeting.room.dto.MeetingRoomDTO$MeetingRoomTest" >
		select mr.mr_id mrId,b.br_id brId,b.br_name brName,mr_name mrName,mr_limit mrLimit,b.BR_LOCATION brLocation,mr_area mrArea,mr_network mrNetwork,mr_type mrType,e.emp_name empName,mr_location mrLocation,mr_img mrImg, LISTAGG(eq.eq_id,',') WITHIN GROUP(ORDER BY r.mr_id) AS eqId 
		from branch b, meeting_room mr, reservation r,employee e,equipment eq
		where r.mr_id = mr.mr_id
		and mr.br_id = b.br_id
		and mr.emp_id = e.emp_id
		and r.mr_id = eq.mr_id
		<if test="!brId.equals('')">
			and b.br_id=#{brId}
		</if>
		<if test="!mrType.equals('')">
			and mr.mr_type=#{mrType}
		</if>
		<if test="!mrLimit.equals('')">
			and mr.mr_limit = #{mrLimit}
		</if>
		<if test="!resStartDate.equals('')">
			and to_char(r.res_start_time)!=#{resStartDate}
		</if>
		group by mr.mr_id,b.br_id,b.br_name,mr_name,mr_limit,b.BR_LOCATION,mr_area,mr_network,mr_type,e.emp_name,mr_location,mr_img
	</select>
	<delete id="cancelRes" parameterType="string">
		delete from reservation
		where res_id = #{resId}
	</delete>
	
</mapper>